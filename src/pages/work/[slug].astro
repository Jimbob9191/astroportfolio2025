---
import CaseStudyLayout from '../../layouts/CaseStudyLayout.astro';
import { caseStudies } from '../../data/caseStudies';

export function getStaticPaths() {
  return caseStudies.map(project => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { title, slug, layout, galleryImages, research, process, outcomes, metrics } = project;

const getGalleryClass = (layout: string) => {
  switch (layout) {
    case 'grid':
      return 'grid grid-cols-1 md:grid-cols-2 gap-8';
    case 'masonry':
      return 'columns-1 md:columns-2 lg:columns-3 gap-8 [&>*]:mb-8';
    case 'fullwidth':
      return 'space-y-8 [&>*]:w-full';
    default:
      return 'grid grid-cols-1 md:grid-cols-2 gap-8';
  }
};

const galleryClass = getGalleryClass(layout);
---

<CaseStudyLayout title={title} slug={slug}>
  {project.slug === 'payment-portal-redesign' && (
    <section class="mb-20">
      <h2 class="text-2xl md:text-3xl font-display font-medium mb-6">Background</h2>
      <p class="text-secondary text-lg leading-relaxed mb-6">
        MYCRS is a payment portal allowing debtors to make payments on debts from other businesses. In 2013 the site was originally designed as a desktop first portal, with only secondary consideration for mobile. By late 2019, consumer behaviour had shifted dramatically, with 95% of traffic now coming from mobile devices.
      </p>
      <p class="text-secondary text-lg leading-relaxed mb-6">
        To address this, I partnered with the development team to redesign the experience for mobile users and re establish MYCRS as a market leading platform. Our goals were to improve conversion rates, prioritise accessibility, improve customer satisfaction and ensure the system was scalable for future enhancements.
      </p>
      <p class="text-secondary text-lg leading-relaxed mb-4">While CRS offers a range of services, the core business model follows a simple flow:</p>
      <ol class="space-y-3 text-secondary text-lg mb-8 list-decimal list-inside">
        <li>A customer purchases a product or service but cannot or does not pay.</li>
        <li>The company attempts to collect the debt but is unsuccessful.</li>
        <li>The debt is referred to CRS.</li>
        <li>CRS engages with the customer, primarily through digital channels, to recover the balance, earning a commission on successful collections.</li>
      </ol>
    </section>
  )}

  {research && (
    <section class="mb-20">
      <h2 class="text-2xl md:text-3xl font-display font-medium mb-8">Research & Discovery</h2>
      <div class="space-y-8">
        <div>
          <h3 class="text-xl font-medium mb-4">Research Methods</h3>
          <p class="text-secondary">{research.methods.join(', ')}</p>
        </div>
        <div>
          <h3 class="text-xl font-medium mb-4">Key Insights</h3>
          <ul class="list-disc list-inside text-secondary space-y-2">
            {research.insights.map(insight => (
              <li>{insight}</li>
            ))}
          </ul>
        </div>
      </div>
    </section>
  )}

  {project.slug === 'finance-app-redesign' && (
    <section class="mb-20">
      <div class="grid grid-cols-1 gap-8" id="research-gallery-finance">
        <a 
          href="/crsmiimages/crsmi-2.webp"
          class="block img-hover rounded-lg overflow-hidden research-gallery-finance-item w-full"
          data-pswp-width="1260"
          data-pswp-height="750"
        >
          <img 
            src="/crsmiimages/crsmi-2.webp" 
            alt="CRSMI client management portal research and user analysis findings" 
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </a>
      </div>
    </section>
  )}

  {project.slug === 'payment-portal-redesign' && (
    <section class="mb-20">
      <div class="grid grid-cols-1 gap-8" id="research-gallery-payment">
        <a 
          href="/mycrsimages/mycrs-3.webp"
          class="block img-hover rounded-lg overflow-hidden research-gallery-payment-item w-full"
          data-pswp-width="1260"
          data-pswp-height="750"
        >
          <img 
            src="/mycrsimages/mycrs-3.webp" 
            alt="MYCRS payment portal research and user analysis findings" 
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </a>
      </div>
    </section>
  )}

  {project.slug === 'finance-app-redesign' && (
    <section class="mb-20">
      <h2 class="text-2xl md:text-3xl font-display font-medium mb-6">Background</h2>
      <p class="text-secondary text-lg leading-relaxed mb-6">
        CRSMI is an internally built data management and reporting platform used by account managers and clients. The platform allows users to manipulate and interrogate data as they please, offering a standard set of reports which can then be expanded further down the line.
      </p>
      <p class="text-secondary text-lg leading-relaxed mb-4">While coeo offers a range of services, the core business model follows a simple flow:</p>
      <ol class="space-y-3 text-secondary text-lg mb-8 list-decimal list-inside">
        <li>A client engages COEO for debt recovery services.</li>
        <li>Account managers use CRSMI to track and manage client portfolios.</li>
        <li>coeo then delivers results and insights back to clients through the same portal.</li>
      </ol>
    </section>
  )}

  {process && (
    <section class="mb-20">
      <h2 class="text-2xl md:text-3xl font-display font-medium mb-8">Process</h2>
      {process.details && (
        <div class="mb-12">
          <div class="prose prose-lg max-w-none">
            {process.details.split('\n\n').map(paragraph => (
              paragraph.includes('*') ? (
                <ul class="space-y-2 text-secondary text-lg">
                  {paragraph.split('\n').filter(line => line.startsWith('*')).map(item => (
                    <li class="flex items-start">
                      <span class="w-2 h-2 bg-primary rounded-full mt-3 mr-4 flex-shrink-0"></span>
                      <span>{item.substring(2)}</span>
                    </li>
                  ))}
                </ul>
              ) : (
                <p class="text-secondary text-lg leading-relaxed mb-6">{paragraph}</p>
              )
            ))}
          </div>
        </div>
      )}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        {process.steps.map(step => (
          <div class="bg-gray-50 p-8 rounded-lg">
            <h3 class="text-xl font-medium mb-4">{step.title}</h3>
            <p class="text-secondary">{step.description}</p>
          </div>
        ))}
      </div>
    </section>
  )}

  {outcomes && (
    <section class="mb-20">
      <h2 class="text-2xl md:text-3xl font-display font-medium mb-8">Outcomes</h2>
      <div class="prose prose-lg max-w-none">
        {outcomes.content.split('\n\n').map(paragraph => (
          paragraph.includes('*') ? (
            <ul class="space-y-3 text-secondary text-lg mb-8">
              {paragraph.split('\n').filter(line => line.startsWith('*')).map(item => (
                <li class="flex items-start">
                  <span class="w-2 h-2 bg-primary rounded-full mt-3 mr-4 flex-shrink-0"></span>
                  <span>{item.substring(2)}</span>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-secondary text-lg leading-relaxed mb-6">{paragraph}</p>
          )
        ))}
      </div>
    </section>
  )}

  <section class="mb-20">
    <h2 class="text-2xl md:text-3xl font-display font-medium mb-8">Project Gallery</h2>
    <div class={galleryClass} id="gallery">
      {galleryImages.map((image) => (
        <a 
          href={image.large}
          class="block img-hover rounded-lg overflow-hidden gallery-item w-full"
          data-pswp-width={image.width}
          data-pswp-height={image.height}
        >
          <img 
            src={image.thumbnail} 
            alt={image.alt}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </a>
      ))}
    </div>
  </section>
    

  {metrics && project.slug !== 'metamask-onboarding' && (
    <section class="mb-20">
      <h2 class="text-2xl md:text-3xl font-display font-medium mb-8">Impact & Results</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
        <div>
          <h3 class="text-xl font-medium mb-6">Before</h3>
          <dl class="space-y-4">
            {Object.entries(metrics.before).map(([key, value]) => (
              <div>
                <dt class="text-secondary">{key.replace(/([A-Z])/g, ' $1').trim()}</dt>
                <dd class="text-2xl font-display font-medium">{value}</dd>
              </div>
            ))}
          </dl>
        </div>
        <div>
          <h3 class="text-xl font-medium mb-6">After</h3>
          <dl class="space-y-4">
            {Object.entries(metrics.after).map(([key, value]) => (
              <div>
                <dt class="text-secondary">{key.replace(/([A-Z])/g, ' $1').trim()}</dt>
                <dd class="text-2xl font-display font-medium">{value}</dd>
              </div>
            ))}
          </dl>
        </div>
      </div>
    </section>
  )}
</CaseStudyLayout>

<script>
  import PhotoSwipe from 'photoswipe';
  import 'photoswipe/dist/photoswipe.css';

  const initPhotoSwipe = () => {
    // Initialize main gallery
    const gallery = document.querySelector('#gallery');
    
    if (gallery) {
      const galleryItems = gallery.querySelectorAll('.gallery-item');
      
      galleryItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          const options = {
            gallery,
            dataSource: Array.from(galleryItems).map(galleryItem => ({
              src: galleryItem.href,
              width: parseInt(galleryItem.getAttribute('data-pswp-width')),
              height: parseInt(galleryItem.getAttribute('data-pswp-height')),
              msrc: galleryItem.querySelector('img').src
            })),
            index,
            showHideAnimationType: 'fade',
            showAnimationDuration: 300,
            hideAnimationDuration: 300,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: true,
            maxSpreadZoom: 2,
            getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
            pinchToClose: true,
            closeOnScroll: false,
            closeOnVerticalDrag: true,
            wheelToZoom: true,
            padding: { top: 20, bottom: 20, left: 20, right: 20 },
            fit: 'contain'
          };
          
          const lightbox = new PhotoSwipe(options);
          lightbox.init();
        });
      });
    }
    
    // Initialize background gallery for CRSMI case study
    const backgroundGallery = document.querySelector('#background-gallery');
    
    if (backgroundGallery) {
      const backgroundGalleryItems = backgroundGallery.querySelectorAll('.background-gallery-item');
      
      backgroundGalleryItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          const options = {
            gallery: backgroundGallery,
            dataSource: Array.from(backgroundGalleryItems).map(galleryItem => ({
              src: galleryItem.href,
              width: parseInt(galleryItem.getAttribute('data-pswp-width')),
              height: parseInt(galleryItem.getAttribute('data-pswp-height')),
              msrc: galleryItem.querySelector('img').src
            })),
            index,
            showHideAnimationType: 'fade',
            showAnimationDuration: 300,
            hideAnimationDuration: 300,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: true,
            maxSpreadZoom: 2,
            getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
            pinchToClose: true,
            closeOnScroll: false,
            closeOnVerticalDrag: true,
            wheelToZoom: true,
            padding: { top: 20, bottom: 20, left: 20, right: 20 },
            fit: 'contain'
          };
          
          const lightbox = new PhotoSwipe(options);
          lightbox.init();
        });
      });
    }
    
    // Initialize problem gallery for Payment Portal case study
    const problemGalleryPayment = document.querySelector('#problem-gallery-payment');
    
    if (problemGalleryPayment) {
      const problemGalleryPaymentItems = problemGalleryPayment.querySelectorAll('.problem-gallery-payment-item');
      
      problemGalleryPaymentItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          const options = {
            gallery: problemGalleryPayment,
            dataSource: Array.from(problemGalleryPaymentItems).map(galleryItem => ({
              src: galleryItem.href,
              width: parseInt(galleryItem.getAttribute('data-pswp-width')),
              height: parseInt(galleryItem.getAttribute('data-pswp-height')),
              msrc: galleryItem.querySelector('img').src
            })),
            index,
            showHideAnimationType: 'fade',
            showAnimationDuration: 300,
            hideAnimationDuration: 300,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: true,
            maxSpreadZoom: 2,
            getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
            pinchToClose: true,
            closeOnScroll: false,
            closeOnVerticalDrag: true,
            wheelToZoom: true,
            padding: { top: 20, bottom: 20, left: 20, right: 20 },
            fit: 'contain'
          };
          
          const lightbox = new PhotoSwipe(options);
          lightbox.init();
        });
      });
    }
    
    // Initialize research gallery for Payment Portal case study
    const researchGalleryPayment = document.querySelector('#research-gallery-payment');
    
    if (researchGalleryPayment) {
      const researchGalleryPaymentItems = researchGalleryPayment.querySelectorAll('.research-gallery-payment-item');
      
      researchGalleryPaymentItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          const options = {
            gallery: researchGalleryPayment,
            dataSource: Array.from(researchGalleryPaymentItems).map(galleryItem => ({
              src: galleryItem.href,
              width: parseInt(galleryItem.getAttribute('data-pswp-width')),
              height: parseInt(galleryItem.getAttribute('data-pswp-height')),
              msrc: galleryItem.querySelector('img').src
            })),
            index,
            showHideAnimationType: 'fade',
            showAnimationDuration: 300,
            hideAnimationDuration: 300,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: true,
            maxSpreadZoom: 2,
            getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
            pinchToClose: true,
            closeOnScroll: false,
            closeOnVerticalDrag: true,
            wheelToZoom: true,
            padding: { top: 20, bottom: 20, left: 20, right: 20 },
            fit: 'contain'
          };
          
          const lightbox = new PhotoSwipe(options);
          lightbox.init();
        });
      });
    }
    
    // Initialize research gallery for Finance App case study
    const researchGalleryFinance = document.querySelector('#research-gallery-finance');
    
    if (researchGalleryFinance) {
      const researchGalleryFinanceItems = researchGalleryFinance.querySelectorAll('.research-gallery-finance-item');
      
      researchGalleryFinanceItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          const options = {
            gallery: researchGalleryFinance,
            dataSource: Array.from(researchGalleryFinanceItems).map(galleryItem => ({
              src: galleryItem.href,
              width: parseInt(galleryItem.getAttribute('data-pswp-width')),
              height: parseInt(galleryItem.getAttribute('data-pswp-height')),
              msrc: galleryItem.querySelector('img').src
            })),
            index,
            showHideAnimationType: 'fade',
            showAnimationDuration: 300,
            hideAnimationDuration: 300,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: true,
            maxSpreadZoom: 2,
            getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
            pinchToClose: true,
            closeOnScroll: false,
            closeOnVerticalDrag: true,
            wheelToZoom: true,
            padding: { top: 20, bottom: 20, left: 20, right: 20 },
            fit: 'contain'
          };
          
          const lightbox = new PhotoSwipe(options);
          lightbox.init();
        });
      });
    }
    
    // Initialize problem gallery for MetaMask case study
    const problemGallery = document.querySelector('#problem-gallery');
    
    if (problemGallery) {
      const problemGalleryItems = problemGallery.querySelectorAll('.problem-gallery-item');
      
      problemGalleryItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          const options = {
            gallery: problemGallery,
            dataSource: Array.from(problemGalleryItems).map(galleryItem => ({
              src: galleryItem.href,
              width: parseInt(galleryItem.getAttribute('data-pswp-width')),
              height: parseInt(galleryItem.getAttribute('data-pswp-height')),
              msrc: galleryItem.querySelector('img').src
            })),
            index,
            showHideAnimationType: 'fade',
            showAnimationDuration: 300,
            hideAnimationDuration: 300,
            bgOpacity: 0.8,
            spacing: 0.1,
            allowPanToNext: true,
            maxSpreadZoom: 2,
            getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
            pinchToClose: true,
            closeOnScroll: false,
            closeOnVerticalDrag: true,
            wheelToZoom: true,
            padding: { top: 20, bottom: 20, left: 20, right: 20 },
            fit: 'contain'
          };
          
          const lightbox = new PhotoSwipe(options);
          lightbox.init();
        });
      });
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    initPhotoSwipe();
  });
</script>