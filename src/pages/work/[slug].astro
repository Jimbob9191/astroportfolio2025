---
import CaseStudyLayout from '../../layouts/CaseStudyLayout.astro';
import { caseStudies } from '../../data/caseStudies';

export function getStaticPaths() {
  return caseStudies.map(project => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { title, slug, layout, galleryImages } = project;

const getGalleryClass = (layout: string) => {
  switch (layout) {
    case 'grid':
      return 'grid grid-cols-1 md:grid-cols-2 gap-8';
    case 'masonry':
      return 'columns-1 md:columns-2 lg:columns-3 gap-8';
    case 'fullwidth':
      return 'space-y-8';
    default:
      return 'grid grid-cols-1 md:grid-cols-2 gap-8';
  }
};

const galleryClass = getGalleryClass(layout);
---

<CaseStudyLayout title={title} slug={slug}>
  <section class="mb-20">
    <div class={galleryClass} id="gallery">
      {galleryImages.map((image) => (
        <a 
          href={image.large}
          class={`block img-hover rounded-lg overflow-hidden gallery-item ${layout === 'masonry' ? 'mb-8' : ''}`}
          data-pswp-width={image.width}
          data-pswp-height={image.height}
        >
          <img 
            src={image.thumbnail} 
            alt={image.alt}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </a>
      ))}
    </div>
  </section>
</CaseStudyLayout>

<script>
  import PhotoSwipe from 'photoswipe';
  import 'photoswipe/dist/photoswipe.css';

  const initPhotoSwipe = () => {
    const gallery = document.querySelector('#gallery');
    
    if (!gallery) return;
    
    const galleryItems = gallery.querySelectorAll('.gallery-item');
    
    galleryItems.forEach((item, index) => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        
        const options = {
          gallery,
          dataSource: Array.from(galleryItems).map(galleryItem => ({
            src: galleryItem.href,
            width: parseInt(galleryItem.getAttribute('data-pswp-width')),
            height: parseInt(galleryItem.getAttribute('data-pswp-height')),
            msrc: galleryItem.querySelector('img').src
          })),
          index,
          showHideAnimationType: 'fade',
          showAnimationDuration: 300,
          hideAnimationDuration: 300,
          bgOpacity: 0.8,
          spacing: 0.1,
          allowPanToNext: true,
          maxSpreadZoom: 2,
          getDoubleTapZoom: (isMouseClick, item) => isMouseClick ? 2 : 1,
          pinchToClose: true,
          closeOnScroll: false,
          closeOnVerticalDrag: true,
          wheelToZoom: true,
          padding: { top: 20, bottom: 20, left: 20, right: 20 },
          fit: 'contain',
          pswpModule: () => import('photoswipe')
        };
        
        const lightbox = new PhotoSwipe(options);
        lightbox.init();
      });
    });
  };

  document.addEventListener('DOMContentLoaded', () => {
    initPhotoSwipe();
  });
</script>